<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æšç¨‹å°¾ç‰™è³“æœç‹</title>
    <style>
        :root { --primary: #d32f2f; --secondary: #ff9800; --accent: #ffeb3b; --bg: #f4f7f9; --win: #43a047; --voice: #673ab7; --gray: #607d8b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 5px; padding-bottom: 115px; padding-top: 85px; -webkit-user-select: none; user-select: none; }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; box-sizing: border-box; }

        .top-container { position: fixed; top: 0; left: 0; width: 100%; z-index: 8000; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .top-settings { display: flex; gap: 5px; padding: 8px; height: 50px; align-items: center; box-sizing: border-box; }
        .notification-bar { background: rgba(34,34,34,0.9); color: white; padding: 5px 0; text-align: center; display: none; max-height: 60px; overflow-y: auto; }
        .notif-item { display: inline-block; margin: 2px 5px; padding: 4px 10px; border-radius: 15px; font-weight: bold; font-size: 11px; cursor: pointer; }
        
        select { flex: 1.5; height: 34px; font-size: 14px; border-radius: 4px; border: 1px solid #ddd; min-width: 80px; }
        .btn-top { height: 34px; font-size: 12px; border: none; background: #eee; border-radius: 4px; padding: 0 8px; white-space: nowrap; }
        
        .spk-toggle { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; }
        .spk-toggle svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        .container { max-width: 500px; margin: auto; }
        .ticket { background: white; border-radius: 8px; padding: 10px; margin-bottom: 12px; border: 1px solid #eee; opacity: 0.5; transition: 0.3s; scroll-margin-top: 95px; }
        .ticket.enabled { opacity: 1; border-color: #ccc; }
        .ticket.bingo { border: 2px solid var(--primary); background: #fffde7; animation: highlight 1s 2; }

        .ticket-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .ticket-name-box { display: flex; align-items: center; gap: 8px; font-size: 17px; font-weight: bold; color: #333; }
        .ticket-name-box input { width: 20px; height: 20px; margin: 0; cursor: pointer; }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .cell { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #eee; border-radius: 50%; font-size: 18px; font-weight: bold; }
        .cell.marked { background: var(--accent); border-color: #fbc02d; }
        .cell.active { border: 2px solid #2196f3 !important; background: #e3f2fd; }
        .cell.empty-alert { border: 2px solid #ff5252 !important; background: #ffebee !important; }
        .cell.locked { opacity: 0.5; background: #f0f0f0; border: 1px dashed #ccc; }
        
        .floating-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; padding: 10px; box-sizing: border-box; z-index: 9000; }
        .row-1 { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        #numInput { width: 65px; height: 40px; font-size: 18px; text-align: center; border: 2px solid var(--secondary); border-radius: 8px; outline: none; flex-shrink: 0; }
        .history-box { flex: 1; height: 40px; display: flex; align-items: center; gap: 5px; overflow-x: auto; background: #f5f5f5; border-radius: 8px; padding: 0 8px; }
        .drawn-btn { background: white; border: 1px solid #ccc; border-radius: 4px; padding: 4px 10px; font-size: 13px; font-weight: bold; flex-shrink: 0; }
        .row-2 { display: flex; gap: 8px; }
        .icon-btn { flex: 1; height: 48px; border: none; border-radius: 8px; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; }
        .btn-voice { background: var(--voice); }
        .btn-voice.active { background: #f44336; animation: blink 1.5s infinite; }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; overflow-y: auto; }
        .modal-content { background:white; width:95%; margin:20px auto; padding:18px; border-radius:15px; box-sizing: border-box; }
        .picker-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; max-height:220px; overflow-y:auto; background:#f0f0f0; padding:10px; border-radius:10px; }
        .num-btn { padding:12px 0; border:1px solid #ddd; background:white; border-radius:6px; font-size:14px; font-weight:bold; }
        .num-btn.disabled { background: #d0d0d0; color: #999; }
        
        @keyframes highlight { 0%, 100% { box-shadow: 0 0 0px var(--primary); } 50% { box-shadow: 0 0 20px var(--primary); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body onload="loadData()">

<div class="top-container">
    <div class="top-settings">
        <select id="gameMode" onchange="changeMode(this.value)">
            <option value="any_line">ä»»ä¸€ç·š</option>
            <option value="cross">åå­—ç·š</option>
            <option value="border">å¤–æ¡†</option>
            <option value="custom">è‡ªè¨‚ç©æ³•</option>
        </select>
        <button id="customConfigBtn" class="btn-top" onclick="openCustomModal()" style="display:none; background:var(--accent); font-weight:bold;">âš™ï¸è¨­å®š</button>
        <button class="btn-top" onclick="toggleAllTickets(true)">âœ…å…¨é¸</button>
        <button class="btn-top" onclick="toggleAllTickets(false)">âŒæ¸…ç©º</button>
        <div id="speakerBtn" class="spk-toggle" onclick="toggleSound()">
            <svg id="s-on" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            <svg id="s-off" viewBox="0 0 24 24" style="display:none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        </div>
    </div>
    <div id="notifBar" class="notification-bar"></div>
</div>

<div class="container" id="ticketList"></div>

<div class="floating-footer">
    <div class="row-1">
        <input type="number" id="numInput" placeholder="è™Ÿç¢¼" oninput="manualInput(this)" pattern="\d*">
        <div id="drawHistory" class="history-box"></div>
    </div>
    <div class="row-2">
        <button id="voiceBtn" class="icon-btn btn-voice" onclick="toggleVoice()">ğŸ™ï¸ èªéŸ³ç›£è½</button>
        <button class="icon-btn" style="background:#555" onclick="resetGame()">ğŸ”„ æ¸…é™¤é–‹ç</button>
        <button class="icon-btn" style="background:var(--win); flex:1.5" onclick="openAddModal()">â• æ–°å¢çåˆ¸</button>
    </div>
</div>

<div id="addModal" class="modal"><div class="modal-content">
    <h3 style="margin:0 0 12px 0; text-align:center;">çåˆ¸ç·¨è¼¯å™¨</h3>
    <input type="text" id="ownerName" placeholder="æŒæœ‰äººå§“å" style="width:100%; padding:12px; margin-bottom:12px; border:1px solid #ccc; border-radius:8px; box-sizing: border-box; font-size:16px;">
    <div class="grid" id="editGrid" style="margin-bottom:15px; padding:8px; background:#f5f5f5; border-radius:10px;"></div>
    <div id="pickerGrid" class="picker-grid"></div>
    <div id="errorMsg" style="color:#d32f2f; font-size:14px; font-weight:bold; margin:12px 0; text-align:center; min-height:20px;"></div>
    <div style="display:flex; gap:10px;">
        <button class="icon-btn" style="background:var(--win); flex:2;" onclick="saveTicket()">ğŸ’¾ å„²å­˜</button>
        <button id="deleteBtn" class="icon-btn" style="background:#f44336; flex:1; display:none;" onclick="deleteCurrentTicket()">ğŸ—‘ï¸ åˆªé™¤</button>
        <button class="icon-btn" style="background:#757575; flex:1;" onclick="closeAddModal()">å–æ¶ˆ</button>
    </div>
</div></div>

<div id="customModal" class="modal"><div class="modal-content">
    <h3 style="margin:0 0 10px 0; text-align:center;">è‡ªè¨‚ç©æ³•è¨­å®š</h3>
    <div style="display:flex; gap:8px; margin-bottom:12px;">
        <button class="btn-top" style="flex:1;" onclick="customSelectAll(true)">âœ… å…¨é¸</button>
        <button class="btn-top" style="flex:1;" onclick="customSelectAll(false)">âŒ æ¸…ç©º</button>
    </div>
    <div class="grid" id="customGrid" style="gap:6px; margin-bottom:20px;"></div>
    <div style="background:#fff9c4; padding:15px; border-radius:10px; border:1px solid #fbc02d; text-align:center; font-weight:bold;">
        éœ€å°ä¸­ <input type="number" id="customCount" value="1" min="1" oninput="updateCustomHint()" style="width:50px; height:30px; text-align:center; border:1px solid #fbc02d; border-radius:4px;"> å€‹è™Ÿç¢¼å³è³“æœ
    </div>
    <button class="icon-btn" style="background:var(--win); width:100%; margin-top:20px; font-size:16px;" onclick="applyCustomMode()">ğŸ’¾ å¥—ç”¨è¦å‰‡</button>
</div></div>

<script>
    /** æ ¸å¿ƒè®Šæ•¸ **/
    let tickets = [], drawnNumbers = [], customPattern = [12], customTarget = 1;
    let isVoiceOn = false, isSoundOn = true, recognition, announcedBingo = new Set(), isInitializing = true;
    let editingData = Array(25).fill(null), activeIndex = 0, editIndex = null;

    const bingoSfx = new Audio('bingo.mp3');

    // è™•ç†è³“æœé‚è¼¯
    function triggerBingoAction() {
        // 1. å¼·åˆ¶é—œé–‰ç›£è½ï¼ˆé¿å…ç¾å ´é ˜çå°–å«è²é€ æˆè·³è™Ÿï¼‰
        if (isVoiceOn) {
            isVoiceOn = false;
            if (recognition) recognition.stop();
            document.getElementById('voiceBtn').classList.remove('active');
        }
        
        // 2. æ’­æ”¾ä¸­çéŸ³æ•ˆ (åƒ…åœ¨å–‡å­é–‹å•Ÿæ™‚)
        if (isSoundOn) {
            bingoSfx.currentTime = 0;
            bingoSfx.play().catch(e => console.log("éœ€äº’å‹•å•Ÿå‹•éŸ³æ•ˆ"));
        }
    }

    function updateSpeakerUI() { document.getElementById('s-on').style.display = isSoundOn ? 'block' : 'none'; document.getElementById('s-off').style.display = isSoundOn ? 'none' : 'block'; }
    function toggleSound() { isSoundOn = !isSoundOn; updateSpeakerUI(); saveData(); }

    function renderAll() {
        const list = document.getElementById('ticketList'), bar = document.getElementById('notifBar'); 
        let barHtml = '', hasNewBingo = false;

        list.innerHTML = tickets.map((t, x) => {
            let mk = [12]; t.data.forEach((v, i) => { if(drawnNumbers.includes(v)) mk.push(i); });
            let s = t.enabled ? checkWin(mk) : { isBingo: false, isReady: false };
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºã€Œæ–°ã€è³“æœ
            if (s.isBingo && !announcedBingo.has(x)) { 
                announcedBingo.add(x); 
                hasNewBingo = true;
            }

            if (s.isBingo) barHtml += `<span class="notif-item" style="background:var(--primary)" onclick="jumpTo(${x})">ğŸ‰ ${t.name} BINGO!</span>`;
            else if (s.isReady) barHtml += `<span class="notif-item" style="background:var(--gray)" onclick="jumpTo(${x})">ğŸ”” ${t.name} è½ç‰Œ</span>`;

            return `<div id="tk-${x}" class="ticket ${t.enabled?'enabled':''} ${s.isBingo?'bingo':''}">
                <div class="ticket-header">
                    <div class="ticket-name-box">
                        <input type="checkbox" ${t.enabled?'checked':''} onchange="toggleTicket(${x})"> 
                        <b>${t.name}</b>
                    </div>
                    <div style="color:#2196f3; font-size:13px; cursor:pointer;" onclick="editTicket(${x})">ç·¨è¼¯/åˆªé™¤</div>
                </div>
                <div class="grid">${t.data.map((n, i) => `<div class="cell ${mk.includes(i)?'marked':''}">${n==='FREE'?'â˜…':n}</div>`).join('')}</div>
            </div>`;
        }).join('');

        if (hasNewBingo) triggerBingoAction();
        bar.style.display = barHtml ? 'block' : 'none'; bar.innerHTML = barHtml;
    }

    /** èªéŸ³è¾¨è­˜ç³»çµ± (é‡æ§‹ç‰ˆ) **/
    function initSpeechEngine() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) return;
        recognition = new SR();
        recognition.continuous = true;
        recognition.lang = 'zh-TW';
        recognition.interimResults = false;

        recognition.onresult = (e) => {
            let text = '';
            for (let i = e.resultIndex; i < e.results.length; ++i) {
                if (e.results[i].isFinal) text += e.results[i][0].transcript;
            }
            if (text) {
                const nums = text.match(/\d+/g);
                if (nums) nums.forEach(m => {
                    const n = parseInt(m);
                    if (n >= 1 && n <= 75 && !drawnNumbers.includes(n)) {
                        drawnNumbers.push(n);
                        updateHistory();
                        renderAll();
                        saveData();
                    }
                });
            }
        };

        recognition.onerror = (e) => {
            console.error("èªéŸ³éŒ¯èª¤:", e.error);
            // ç™¼ç”ŸéŒ¯èª¤æ™‚å¦‚æœé–‹é—œä»é–‹å•Ÿï¼Œå…ˆåœå†é‡å•Ÿï¼Œé¿å…é–æ­»
            if (isVoiceOn) {
                recognition.stop();
                setTimeout(() => { if(isVoiceOn) try { recognition.start(); } catch(err){} }, 300);
            }
        };

        recognition.onend = () => {
            // é€™æ˜¯é—œéµï¼šå¦‚æœæ˜¯ä½¿ç”¨è€…æ‰‹å‹•é—œæ‰ï¼Œå°±ä¸æœƒé‡å•Ÿ
            if (isVoiceOn) {
                setTimeout(() => { if(isVoiceOn) try { recognition.start(); } catch(err){} }, 300);
            }
        };
    }

    function toggleVoice() {
        if (!recognition) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³ç›£è½");
        const btn = document.getElementById('voiceBtn');

        if (!isVoiceOn) {
            isVoiceOn = true;
            btn.classList.add('active');
            try { recognition.start(); } catch(e) { 
                recognition.stop(); 
                setTimeout(() => recognition.start(), 300);
            }
        } else {
            isVoiceOn = false;
            btn.classList.remove('active');
            recognition.stop(); // åœæ­¢å¾Œï¼Œonend æœƒæª¢æŸ¥ isVoiceOnï¼Œæ‰€ä»¥ä¸æœƒé‡å•Ÿ
        }
    }

    // åˆå§‹åŒ–è¾¨è­˜å™¨
    initSpeechEngine();

    /** å…¶ä»–åŸºç¤é‚è¼¯ **/
    function checkWin(mk) {
        const m = document.getElementById('gameMode').value, ls = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
        let ib = false, ir = false;
        const c = (p, t) => {
            const rp = p.filter(i => i !== 12); if (rp.length === 0 || (m === 'custom' && t === 0)) return;
            const mc = rp.filter(i => mk.includes(i)).length, wc = (t === 0 || t > rp.length) ? rp.length : t;
            if (mc >= wc) ib = true; else if (mc === wc - 1) ir = true;
        };
        if(m === 'any_line') ls.forEach(l => c(l, 0));
        else if(m === 'cross') c([2,7,12,17,22,10,11,13,14], 0);
        else if(m === 'border') c([0,1,2,3,4,5,9,10,14,15,19,20,21,22,23,24], 0);
        else if(m === 'custom') c(customPattern, customTarget);
        return { isBingo: ib, isReady: ib ? false : ir };
    }
    function changeMode(v) { document.getElementById('customConfigBtn').style.display=(v==='custom')?'inline-block':'none'; announcedBingo.clear(); renderAll(); saveData(); }
    function manualInput(i) { const n = parseInt(i.value); if (i.value.length >= 2) { if (n >= 1 && n <= 75 && !drawnNumbers.includes(n)) { drawnNumbers.push(n); updateHistory(); renderAll(); saveData(); } i.value = ''; } }
    function updateHistory() { const h = document.getElementById('drawHistory'); h.innerHTML = drawnNumbers.map((n, i) => `<button class="drawn-btn" onclick="removeNumber(${i})">${n}</button>`).join(''); h.scrollLeft = h.scrollWidth; }
    function removeNumber(i) { if (confirm(`åˆªé™¤è™Ÿç¢¼ [ ${drawnNumbers[i]} ]ï¼Ÿ`)) { drawnNumbers.splice(i, 1); announcedBingo.clear(); updateHistory(); renderAll(); saveData(); } }
    function resetGame() { if (confirm("é‡æ–°é–‹å±€ï¼Ÿæ‰€æœ‰é–‹çè¨˜éŒ„å°‡æ¶ˆå¤±")) { drawnNumbers = []; announcedBingo.clear(); updateHistory(); renderAll(); saveData(); } }
    function toggleTicket(i) { tickets[i].enabled = !tickets[i].enabled; announcedBingo.clear(); renderAll(); saveData(); }
    function toggleAllTickets(v) { tickets.forEach(t => t.enabled = v); announcedBingo.clear(); renderAll(); saveData(); }
    function jumpTo(i) { document.getElementById('tk-' + i)?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
    function saveData() { localStorage.setItem('bingo_v2_9_stable', JSON.stringify({t:tickets, d:drawnNumbers, m:document.getElementById('gameMode').value, p:customPattern, c:customTarget, s:isSoundOn})); }
    function loadData() { 
        isInitializing = true;
        const saved = localStorage.getItem('bingo_v2_9_stable'); 
        if (saved) { 
            const d = JSON.parse(saved); tickets = d.t || []; drawnNumbers = d.d || []; 
            isSoundOn = d.s !== undefined ? d.s : true;
            document.getElementById('gameMode').value = d.m || 'any_line'; 
            updateSpeakerUI(); updateHistory(); renderAll(); 
        } 
        isInitializing = false;
    }

    // ç·¨è¼¯å™¨é‚è¼¯
    function openAddModal() { editIndex = null; editingData = Array(25).fill(null); editingData[12] = "FREE"; activeIndex = 0; document.getElementById('ownerName').value = ""; document.getElementById('deleteBtn').style.display = 'none'; renderEditGrid(); document.getElementById('addModal').style.display = 'block'; }
    function renderEditGrid(alertIndices = []) {
        document.getElementById('editGrid').innerHTML = editingData.map((v, i) => `<div class="cell ${(i===activeIndex)?'active':''} ${alertIndices.includes(i)?'empty-alert':''} ${(i===12)?'locked':''}" onclick="${(i===12)?'':'activeIndex='+i+';renderEditGrid()'}">${(i===12)?'â˜…':(v||'')}</div>`).join('');
        document.getElementById('pickerGrid').innerHTML = Array.from({length:75}, (_,i)=>i+1).map(n => `<button class="num-btn ${editingData.includes(n)?'disabled':''}" onclick="${editingData.includes(n)?'':'pickNumber('+n+')'}">${n}</button>`).join('');
    }
    function pickNumber(n) { editingData[activeIndex] = n; let next = activeIndex + 1; if (next === 12) next = 13; if (next < 25) activeIndex = next; renderEditGrid(); }
    function saveTicket() {
        const name = document.getElementById('ownerName').value.trim() || `çåˆ¸ ${tickets.length + 1}`;
        if (editIndex !== null) tickets[editIndex] = { name: name, data: [...editingData], enabled: true };
        else tickets.push({ name: name, data: [...editingData], enabled: true });
        closeAddModal(); renderAll(); saveData();
    }
    function editTicket(i) { editIndex = i; editingData = [...tickets[i].data]; document.getElementById('ownerName').value = tickets[i].name; activeIndex = 0; document.getElementById('deleteBtn').style.display = 'block'; renderEditGrid(); document.getElementById('addModal').style.display = 'block'; }
    function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }
    function deleteCurrentTicket() { if (editIndex !== null && confirm("åˆªé™¤é€™å¼µçåˆ¸ï¼Ÿ")) { tickets.splice(editIndex, 1); closeAddModal(); renderAll(); saveData(); } }
</script>
</body>
</html>
