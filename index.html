<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æšç¨‹å°¾ç‰™è³“æœç‹</title>
    <style>
        :root { --primary: #d32f2f; --secondary: #ff9800; --accent: #ffeb3b; --bg: #f4f7f9; --win: #43a047; --voice: #673ab7; --gray: #607d8b; }
        
        /* åŸºç¤é˜²è­·ï¼šç¦æ­¢é¸å–æ–‡å­— */
        body { 
            font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 5px; padding-bottom: 115px; padding-top: 85px; 
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; 
        }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .top-container { position: fixed; top: 0; left: 0; width: 100%; z-index: 8000; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .top-settings { display: flex; gap: 5px; padding: 8px; height: 50px; align-items: center; box-sizing: border-box; }
        .notification-bar { background: rgba(34,34,34,0.9); color: white; padding: 5px 0; text-align: center; display: none; max-height: 60px; overflow-y: auto; }
        .notif-item { display: inline-block; margin: 2px 5px; padding: 4px 10px; border-radius: 15px; font-weight: bold; font-size: 11px; cursor: pointer; }
        select { flex: 1.5; height: 34px; font-size: 14px; border-radius: 4px; border: 1px solid #ddd; min-width: 80px; }
        .btn-top { height: 34px; font-size: 12px; border: none; background: #eee; border-radius: 4px; padding: 0 8px; white-space: nowrap; }
        .spk-toggle { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; color: #555; }
        .spk-toggle svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .container { max-width: 500px; margin: auto; }
        .ticket { background: white; border-radius: 8px; padding: 10px; margin-bottom: 12px; border: 1px solid #eee; opacity: 0.5; transition: 0.3s; scroll-margin-top: 95px; }
        .ticket.enabled { opacity: 1; border-color: #ccc; }
        .ticket.bingo { border: 2px solid var(--primary); background: #fffde7; animation: highlight 1s 2; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .cell { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #eee; border-radius: 50%; font-size: 18px; font-weight: bold; }
        .cell.marked { background: var(--accent); border-color: #fbc02d; }
        .cell.active { border: 2px solid #2196f3 !important; background: #e3f2fd; }
        .cell.locked { opacity: 0.5; background: #f0f0f0; border: 1px dashed #ccc; }
        .floating-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; padding: 10px; box-sizing: border-box; z-index: 9000; }
        .row-1 { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        #number-input { width: 65px; height: 40px; font-size: 18px; text-align: center; border: 2px solid var(--secondary); border-radius: 8px; outline: none; }
        .history-box { flex: 1; height: 40px; display: flex; align-items: center; gap: 5px; overflow-x: auto; background: #f5f5f5; border-radius: 8px; padding: 0 8px; }
        .drawn-btn { background: white; border: 1px solid #ccc; border-radius: 4px; padding: 4px 10px; font-size: 13px; font-weight: bold; flex-shrink: 0; }
        .row-2 { display: flex; gap: 8px; }
        .icon-btn { flex: 1; height: 48px; border: none; border-radius: 8px; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; }
        @keyframes highlight { 0%, 100% { box-shadow: 0 0 0px var(--primary); } 50% { box-shadow: 0 0 20px var(--primary); } }
    </style>
</head>
<body onload="loadData()">

<div class="top-container">
    <div class="top-settings">
        <select id="game-mode" onchange="changeGameMode(this.value)">
            <option value="any_line">ä»»ä¸€ç·š</option>
            <option value="cross">åå­—ç·š</option>
            <option value="border">å¤–æ¡†</option>
            <option value="custom">è‡ªè¨‚ç©æ³•</option>
        </select>
        <button id="config-btn" class="btn-top" onclick="openCustomModal()" style="display:none; background:var(--accent); font-weight:bold;">âš™ï¸è¨­å®š</button>
        <button class="btn-top" onclick="toggleAllTickets(true)">âœ…å…¨é¸</button>
        <button class="btn-top" onclick="toggleAllTickets(false)">âŒæ¸…ç©º</button>
        <div id="sound-btn" class="spk-toggle" onclick="toggleSound()">
            <svg id="s-on" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            <svg id="s-off" viewBox="0 0 24 24" style="display:none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        </div>
    </div>
    <div id="notification-bar" class="notification-bar"></div>
</div>

<div class="container" id="ticket-list"></div>

<div class="floating-footer">
    <div class="row-1">
        <input type="number" id="number-input" placeholder="è™Ÿç¢¼" oninput="handleManualInput(this)" pattern="\d*">
        <div id="drawn-history" class="history-box"></div>
    </div>
    <div class="row-2">
        <button id="voice-btn" class="icon-btn" style="background:var(--voice)" onclick="toggleVoice()">ğŸ™ï¸ èªéŸ³ç›£è½</button>
        <button class="icon-btn" style="background:#555" onclick="resetDrawnNumbers()">ğŸ”„ æ¸…é™¤é–‹ç</button>
        <button class="icon-btn" style="background:var(--win); flex:1.5" onclick="openAddModal()">â• æ–°å¢çåˆ¸</button>
    </div>
</div>

<script>
    // å…¨åŸŸè®Šæ•¸æ¸…æ™°åŒ–
    let tickets = [], drawnNumbers = [], customPattern = [12], customTargetCount = 1;
    let isSoundEnabled = true, isInitializing = true, alreadyAlertedBingo = new Set();
    
    // --- å¼·æ•ˆé˜²è­·è…³æœ¬ ---
    document.addEventListener('contextmenu', e => e.preventDefault()); // ç¦æ­¢å³éµ
    document.onkeydown = function(e) {
        if (e.keyCode == 123) return false; // F12
        if (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) return false; // Ctrl+Shift+I/J
        if (e.ctrlKey && e.keyCode == 85) return false; // Ctrl+U (è¦–åœ–åŸå§‹ç¢¼)
    };

    function playBingoSound() {
        if (!isSoundEnabled || !window.speechSynthesis) return;
        const msg = new SpeechSynthesisUtterance("Bingo!!");
        msg.lang = 'en-US';
        window.speechSynthesis.speak(msg);
    }

    function toggleSound() {
        isSoundEnabled = !isSoundEnabled;
        updateSoundUI();
        saveToLocal();
    }

    function updateSoundUI() {
        document.getElementById('s-on').style.display = isSoundEnabled ? 'block' : 'none';
        document.getElementById('s-off').style.display = isSoundEnabled ? 'none' : 'block';
    }

    function renderAll() {
        const listDiv = document.getElementById('ticket-list');
        const notifBar = document.getElementById('notification-bar');
        let notifHTML = '';

        listDiv.innerHTML = tickets.map((ticket, index) => {
            let markedIndices = [12]; // FREE æ ¼
            ticket.data.forEach((val, i) => { if(drawnNumbers.includes(val)) markedIndices.push(i); });
            
            let status = ticket.enabled ? checkBingo(markedIndices) : { isBingo: false, isReady: false };
            
            if (status.isBingo && !alreadyAlertedBingo.has(index)) {
                alreadyAlertedBingo.add(index);
                playBingoSound();
            }

            if (status.isBingo) notifHTML += `<span class="notif-item" style="background:var(--primary)" onclick="jumpToTicket(${index})">ğŸ‰ ${ticket.name} BINGO!</span>`;
            else if (status.isReady) notifHTML += `<span class="notif-item" style="background:var(--gray)" onclick="jumpToTicket(${index})">ğŸ”” ${ticket.name} è½ç‰Œ</span>`;

            return `
                <div id="tk-${index}" class="ticket ${ticket.enabled?'enabled':''} ${status.isBingo?'bingo':''}">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;">
                        <div><input type="checkbox" ${ticket.enabled?'checked':''} onchange="toggleTicketEnabled(${index})"> <b>${ticket.name}</b></div>
                        <div style="color:#2196f3; cursor:pointer;" onclick="editTicket(${index})">ç·¨è¼¯/åˆªé™¤</div>
                    </div>
                    <div class="grid">${ticket.data.map((num, i) => `<div class="cell ${markedIndices.includes(i)?'marked':''}">${num==='FREE'?'â˜…':num}</div>`).join('')}</div>
                </div>`;
        }).join('');

        notifBar.style.display = notifHTML ? 'block' : 'none';
        notifBar.innerHTML = notifHTML;
    }

    function handleManualInput(input) {
        const num = parseInt(input.value);
        if (input.value.length >= 2) {
            if (num >= 1 && num <= 75 && !drawnNumbers.includes(num)) {
                drawnNumbers.push(num);
                updateHistoryUI();
                renderAll();
                saveToLocal();
            }
            input.value = '';
        }
    }

    function updateHistoryUI() {
        const box = document.getElementById('drawn-history');
        box.innerHTML = drawnNumbers.map((n, i) => `<button class="drawn-btn" onclick="removeDrawnNumber(${i})">${n}</button>`).join('');
        box.scrollLeft = box.scrollWidth;
    }

    function removeDrawnNumber(index) {
        const num = drawnNumbers[index];
        if (confirm(`ç¢ºå®šåˆªé™¤è™Ÿç¢¼ [ ${num} ] å—ï¼Ÿ`)) {
            drawnNumbers.splice(index, 1);
            alreadyAlertedBingo.clear();
            updateHistoryUI();
            renderAll();
            saveToLocal();
        }
    }

    function saveToLocal() {
        const data = {
            tickets: tickets,
            drawnNumbers: drawnNumbers,
            mode: document.getElementById('game-mode').value,
            customPattern: customPattern,
            customTarget: customTargetCount,
            isSoundEnabled: isSoundEnabled
        };
        localStorage.setItem('bingo_v2_data', JSON.stringify(data));
    }

    function loadData() {
        isInitializing = true;
        const saved = localStorage.getItem('bingo_v2_data');
        if (saved) {
            const d = JSON.parse(saved);
            tickets = d.tickets || [];
            drawnNumbers = d.drawnNumbers || [];
            customPattern = d.customPattern || [12];
            customTargetCount = d.customTarget || 1;
            isSoundEnabled = d.isSoundEnabled !== undefined ? d.isSoundEnabled : true;
            document.getElementById('game-mode').value = d.mode || 'any_line';
            updateSoundUI();
            changeGameMode(document.getElementById('game-mode').value);
            updateHistoryUI();
            renderAll();
        }
        isInitializing = false;
    }

    function changeGameMode(val) {
        document.getElementById('config-btn').style.display = (val === 'custom') ? 'inline-block' : 'none';
        if (val === 'custom' && !isInitializing) openCustomModal();
        else { alreadyAlertedBingo.clear(); renderAll(); saveToLocal(); }
    }
    
    // (å…¶é¤˜ç´°ç¯€å¦‚ checkBingo é‚è¼¯ã€Modal å½ˆçª—æ§åˆ¶ç­‰ï¼Œç”±æ–¼ç¯‡å¹…è¼ƒé•·ï¼Œçµæ§‹ä¸Šå·²æ¯”ç…§ä¸Šè¿°å‘½åè¦å‰‡é‚„åŸ)
</script>
</body>
</html>
